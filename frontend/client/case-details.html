<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Details - Legal Case Management</title>
    <link rel="stylesheet" href="../styles.css">
</head>

<body>
    <div class="header">
        <div class="header-content">
            <h1>Legal Case Management</h1>
            <nav class="nav-links">
                <a href="dashboard.html">Dashboard</a>
                <a href="my-cases.html">My Cases</a>
                <a href="profile.html">Profile</a>
                <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
            </nav>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div id="case-overview">
                <p class="loading">Loading case details...</p>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="overview">Overview</button>
                <button class="tab" data-tab="appointments">Appointments</button>
                <button class="tab" data-tab="updates">Case Updates</button>
                <button class="tab" data-tab="messages">Messages</button>
                <button class="tab" data-tab="documents">Documents</button>
                <button class="tab" data-tab="followups">Follow-Ups</button>
            </div>

            <!-- Overview Tab -->
            <div id="overview" class="tab-content active">
                <div id="overview-content"></div>
            </div>

            <!-- Appointments Tab -->
            <div id="appointments" class="tab-content">
                <h3>Request New Appointment</h3>
                <form id="appointment-form">
                    <div class="form-group">
                        <label for="preferred-datetime">Preferred Date & Time</label>
                        <input type="datetime-local" id="preferred-datetime" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Request Appointment</button>
                </form>
                <div id="appointment-message"></div>
            </div>

            <!-- Updates Tab -->
            <div id="updates" class="tab-content">
                <div id="updates-content">
                    <p class="text-muted">No updates yet</p>
                </div>
            </div>

            <!-- Messages Tab -->
            <div id="messages" class="tab-content">
                <div class="messages-container" id="messages-list"></div>
                <form id="message-form">
                    <div class="form-group">
                        <textarea id="message-content" placeholder="Type your message..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Send Message</button>
                </form>
            </div>

            <!-- Documents Tab -->
            <div id="documents" class="tab-content">
                <form id="document-form" class="mb-2">
                    <div class="form-group">
                        <label for="filename">Document Name</label>
                        <input type="text" id="filename" placeholder="e.g., contract.pdf" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Upload Document (Simulated)</button>
                </form>
                <ul id="documents-list" class="document-list"></ul>
            </div>

            <!-- Follow-Ups Tab -->
            <div id="followups" class="tab-content">
                <div id="followups-content">
                    <p class="text-muted">No follow-ups scheduled</p>
                </div>
            </div>
        </div>
    </div>

    <script src="../app.js"></script>
    <script>
        if (!requireAuth('client')) {
            // Redirected
        }

        const urlParams = new URLSearchParams(window.location.search);
        const caseId = urlParams.get('id');

        if (!caseId) {
            window.location.href = 'my-cases.html';
        }

        let caseData = {};

        async function loadCaseDetails() {
            try {
                const data = await API.getCaseDetails(caseId);
                caseData = data.case;

                // Overview section
                document.getElementById('case-overview').innerHTML = `
                    <h2>${caseData.case_id} 
                        ${caseData.urgency ? '<span class="urgent-badge">Urgent</span>' : ''}
                    </h2>
                `;

                document.getElementById('overview-content').innerHTML = `
                    <p><strong>Case Type:</strong> ${caseData.case_type}</p>
                    <p><strong>Status:</strong> <span class="case-status status-${caseData.status}">${formatStatus(caseData.status)}</span></p>
                    <p><strong>Assigned Lawyer:</strong> ${caseData.lawyer_id || 'Waiting for lawyer to claim'}</p>
                    <p><strong>Description:</strong></p>
                    <p>${caseData.description}</p>
                    <p><strong>Created:</strong> ${formatDate(caseData.created_at)}</p>
                    <p><strong>Last Updated:</strong> ${formatDate(caseData.updated_at)}</p>
                `;

                // Case updates
                if (data.case.updates && data.case.updates.length > 0) {
                    document.getElementById('updates-content').innerHTML = data.case.updates.reverse().map(update => `
                        <div class="card">
                            <p><strong>Status Changed:</strong> ${update.old_status} â†’ ${update.new_status}</p>
                            <p><strong>Notes:</strong> ${update.notes || 'No notes'}</p>
                            <p class="text-muted" style="font-size: 12px;">${formatDate(update.timestamp)}</p>
                        </div>
                    `).join('');
                }

                // Messages
                loadMessages(data.messages);

                // Documents
                loadDocuments(data.documents);

                // Follow-ups
                if (data.followups && data.followups.length > 0) {
                    document.getElementById('followups-content').innerHTML = data.followups.map(f => `
                        <div class="card">
                            <p><strong>Type:</strong> ${f.type}</p>
                            <p><strong>Scheduled:</strong> ${formatDate(f.scheduled_date)}</p>
                            <p><strong>Notes:</strong> ${f.notes || 'No notes'}</p>
                        </div>
                    `).join('');
                }

            } catch (error) {
                console.error('Error loading case:', error);
                showAlert('Error loading case: ' + error.message, 'error');
            }
        }

        function loadMessages(messages) {
            const messagesDiv = document.getElementById('messages-list');
            if (messages && messages.length > 0) {
                messagesDiv.innerHTML = messages.map(m => `
                    <div class="message ${m.sender_role}">
                        <div class="message-sender">${m.sender_role === 'client' ? 'You' : 'Lawyer'}</div>
                        <div class="message-content">${m.content}</div>
                        <div class="message-time">${formatDate(m.timestamp)}</div>
                    </div>
                `).join('');
            } else {
                messagesDiv.innerHTML = '<p class="text-muted">No messages yet</p>';
            }
        }

        function loadDocuments(documents) {
            const docsDiv = document.getElementById('documents-list');
            if (documents && documents.length > 0) {
                docsDiv.innerHTML = documents.map(d => `
                    <li class="document-item">
                        <div>
                            <div class="document-name">${d.filename}</div>
                            <div class="document-meta">Uploaded: ${formatDate(d.uploaded_at)}</div>
                        </div>
                        <button class="btn btn-primary" onclick="alert('Download: ${d.filename}')">Download</button>
                    </li>
                `).join('');
            } else {
                docsDiv.innerHTML = '<p class="text-muted">No documents uploaded</p>';
            }
        }

        // Appointment form
        document.getElementById('appointment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const datetime = document.getElementById('preferred-datetime').value;
            const messageDiv = document.getElementById('appointment-message');

            try {
                await API.requestAppointment(caseId, new Date(datetime).toISOString());
                messageDiv.innerHTML = '<div class="alert alert-success">Appointment requested successfully!</div>';
                document.getElementById('appointment-form').reset();
            } catch (error) {
                messageDiv.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
            }
        });

        // Message form
        document.getElementById('message-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = document.getElementById('message-content').value;

            try {
                await API.sendMessage(caseId, content);
                document.getElementById('message-content').value = '';
                const data = await API.getCaseDetails(caseId);
                loadMessages(data.messages);
            } catch (error) {
                showAlert('Error sending message: ' + error.message, 'error');
            }
        });

        // Document form
        document.getElementById('document-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const filename = document.getElementById('filename').value;

            try {
                await API.uploadDocument(caseId, filename, `/uploads/${filename}`);
                showAlert('Document uploaded successfully!', 'success');
                document.getElementById('filename').value = '';
                const data = await API.getCaseDetails(caseId);
                loadDocuments(data.documents);
            } catch (error) {
                showAlert('Error uploading document: ' + error.message, 'error');
            }
        });

        // Initialize
        initTabs();
        loadCaseDetails();
    </script>
</body>

</html>