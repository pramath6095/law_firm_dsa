<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cases - Legal Case Management</title>
    <link rel="stylesheet" href="../styles.css">
</head>

<body>
    <div class="header">
        <div class="header-content">
            <h1>Legal Case Management - Client Portal</h1>
            <nav class="nav-links">
                <a href="dashboard.html">Dashboard</a>
                <a href="my-cases.html">My Cases</a>
                <a href="create-case.html">Create Case</a>
                <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
            </nav>
        </div>
    </div>

    <div class="container">
        <h2>My Cases</h2>

        <div class="tabs">
            <button class="tab active" data-tab="active">Active Cases</button>
            <button class="tab" data-tab="closed">Closed Cases</button>
        </div>

        <div id="active" class="tab-content active">
            <div id="active-cases-list">
                <p class="loading">Loading active cases...</p>
            </div>
        </div>

        <div id="closed" class="tab-content">
            <div id="closed-cases-list">
                <p class="loading">Loading closed cases...</p>
            </div>
        </div>
    </div>

    <script src="../app.js"></script>
    <script>
        if (!requireAuth('client')) {
            // Redirected
        }

        let allCases = [];

        async function loadCases() {
            try {
                const data = await API.getClientCases();
                allCases = data.cases || [];

                // Separate active and closed cases
                const activeCases = allCases.filter(c => c.status !== 'closed');
                const closedCases = allCases.filter(c => c.status === 'closed');

                // Sort by created_at descending (latest first - LIFO/Stack order)
                activeCases.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                closedCases.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                displayCases('active-cases-list', activeCases);
                displayCases('closed-cases-list', closedCases);

            } catch (error) {
                console.error('Error loading cases:', error);
                showAlert('Error loading cases: ' + error.message, 'error');
            }
        }

        function displayCases(containerId, cases) {
            const casesDiv = document.getElementById(containerId);

            if (cases && cases.length > 0) {
                casesDiv.innerHTML = cases.map(c => {
                    const urgencyClass = c.urgency_level === 'urgent' ? 'urgent' :
                        c.urgency_level === 'high' ? 'high' : 'normal';
                    const daysText = c.days_until_hearing !== undefined ?
                        `Hearing in ${c.days_until_hearing} days` : '';

                    return `
                    <div class="case-item ${urgencyClass}" onclick="window.location.href='case-details.html?id=${c.case_id}'">
                        <div class="case-header">
                            <div class="case-id">${c.case_id}</div>
                            <span class="case-status status-${c.status}">${formatStatus(c.status)}</span>
                        </div>
                        <div class="case-info">
                            <div class="case-type">${c.case_type}</div>
                            <div class="case-lawyer">Lawyer: ${c.lawyer_id || 'Not assigned'}</div>
                        </div>
                        ${daysText ? `<div class="case-days">${daysText}</div>` : ''}
                    </div>
                `}).join('');
            } else {
                casesDiv.innerHTML = `<p class="text-muted">No ${containerId.includes('active') ? 'active' : 'closed'} cases</p>`;
            }
        }

        // Tab functionality
        initTabs();
        loadCases();
    </script>
</body>

</html>