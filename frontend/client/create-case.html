<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Case - Legal Case Management</title>
    <link rel="stylesheet" href="../styles.css">
    <style>
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f0f0f0;
            margin: 0 5px;
            border-radius: 5px;
            font-weight: 500;
        }

        .step.active {
            background: var(--primary-color);
            color: white;
        }

        .step.completed {
            background: #28a745;
            color: white;
        }

        .lawyer-card {
            border: 2px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .lawyer-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .lawyer-card.selected {
            border-color: var(--primary-color);
            background: #f0f8ff;
        }

        .lawyer-card.busy {
            opacity: 0.6;
            border-color: #999;
            cursor: not-allowed;
        }

        .lawyer-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lawyer-details {
            flex: 1;
        }

        .lawyer-cost {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .case-count {
            font-size: 12px;
            color: #666;
        }

        #modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        #modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="header-content">
            <h1>Legal Case Management</h1>
            <nav class="nav-links">
                <a href="dashboard.html">Dashboard</a>
                <a href="my-cases.html">My Cases</a>
                <a href="profile.html">Profile</a>
                <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
            </nav>
        </div>
    </div>

    <div class="container">
        <div class="card" style="max-width: 800px; margin: 0 auto;">
            <h2>Create New Case</h2>

            <div class="step-indicator">
                <div class="step active" id="step1">1. Legal Domain</div>
                <div class="step" id="step2">2. Select Lawyer</div>
                <div class="step" id="step3">3. Case Details</div>
            </div>

            <div id="message-area"></div>

            <form id="create-case-form">
                <!-- Step 1: Domain Selection -->
                <div id="domain-step" class="form-step">
                    <div class="form-group">
                        <label for="case-type">What type of legal help do you need? *</label>
                        <select id="case-type" required>
                            <option value="">Select legal domain...</option>
                            <option value="Civil">Civil Law (Disputes, Contracts, Property Issues)</option>
                            <option value="Criminal">Criminal Law (Criminal Defense, Charges)</option>
                            <option value="Family">Family Law (Divorce, Custody, Adoption)</option>
                            <option value="Corporate">Corporate Law (Business, Contracts)</option>
                            <option value="Property">Property Law (Real Estate, Land Issues)</option>
                            <option value="Tax">Tax Law (Tax Disputes, Planning)</option>
                            <option value="Employment">Employment Law (Workplace Issues)</option>
                        </select>
                    </div>
                </div>

                <!-- Step 2: Lawyer Selection -->
                <div id="lawyer-step" class="form-step" style="display: none;">
                    <h3>Available <span id="selected-domain"></span> Specialists</h3>
                    <div id="lawyers-list"></div>
                    <input type="hidden" id="selected-lawyer-id">
                </div>

                <!-- Step 3: Case Details -->
                <div id="details-step" class="form-step" style="display: none;">
                    <div class="form-group">
                        <label for="description">Case Description *</label>
                        <textarea id="description" required placeholder="Describe your legal issue in detail..."
                            rows="5"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="hearing-date">Court Hearing Date & Time *</label>
                        <input type="datetime-local" id="hearing-date" required>
                        <small>When is your court hearing scheduled?</small>
                    </div>

                    <div class="form-group">
                        <p><strong>Selected Lawyer:</strong> <span id="selected-lawyer-name"></span></p>
                        <p><strong>Speciality:</strong> <span id="selected-lawyer-spec"></span></p>
                        <p><strong>Cost per Hearing:</strong> $<span id="selected-lawyer-cost"></span></p>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;">Create Case</button>
                </div>
            </form>
        </div>
    </div>

    <!-- All Busy Modal -->
    <div id="modal">
        <div class="modal-content">
            <h2>‚ö†Ô∏è All Specialists Busy</h2>
            <p id="modal-message"></p>
            <p style="margin: 20px 0;">
                <strong>Contact Us:</strong><br>
                üìû <span id="modal-phone"></span><br>
                ‚úâÔ∏è <span id="modal-email"></span>
            </p>
            <button class="btn btn-primary" onclick="closeModal()">Close</button>
        </div>
    </div>

    <script src="../app.js"></script>
    <script>
        if (!requireAuth('client')) {
            // Redirected
        }

        let allLawyers = [];
        let currentStep = 1;

        // Load all lawyers on page load
        async function loadLawyers() {
            try {
                const data = await API.getLawyers();
                allLawyers = data.lawyers || [];
            } catch (error) {
                console.error('Error loading lawyers:', error);
            }
        }

        // Step 1: Domain selection
        document.getElementById('case-type').addEventListener('change', (e) => {
            const domain = e.target.value;
            if (domain) {
                document.getElementById('selected-domain').textContent = domain;
                showLawyers(domain);
                goToStep(2);
            }
        });

        // Show lawyers filtered by domain
        function showLawyers(domain) {
            const domainMap = {
                'Civil': 'Civil Law',
                'Criminal': 'Criminal Law',
                'Family': 'Family Law',
                'Corporate': 'Corporate Law',
                'Property': 'Property Law',
                'Tax': 'Tax Law',
                'Employment': 'Employment Law'
            };

            const targetSpeciality = domainMap[domain] || domain;
            const filteredLawyers = allLawyers.filter(l => l.speciality === targetSpeciality);

            const lawyersList = document.getElementById('lawyers-list');

            if (filteredLawyers.length === 0) {
                lawyersList.innerHTML = `
                    <div class="alert alert-warning">
                        No lawyers available for ${domain} law at the moment.
                        <p style="margin-top: 10px;">Contact us: +1-555-LAW-FIRM</p>
                    </div>
                `;
                return;
            }

            lawyersList.innerHTML = filteredLawyers.map(lawyer => `
                <div class="lawyer-card" data-lawyer-id="${lawyer.user_id}" onclick="selectLawyer('${lawyer.user_id}')">
                    <div class="lawyer-info">
                        <div class="lawyer-details">
                            <h4 style="margin: 0 0 5px 0;">${lawyer.name}</h4>
                            <p style="margin: 0; font-size: 14px; color: #666;">${lawyer.speciality}</p>
                            <p class="case-count">Active cases: ${lawyer.active_cases || 0} / 2</p>
                        </div>
                        <div class="lawyer-cost">
                            $${lawyer.cost_per_hearing.toLocaleString()}
                            <div style="font-size: 12px; font-weight: normal; color: #666;">per hearing</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Select lawyer
        function selectLawyer(lawyerId) {
            // Deselect all
            document.querySelectorAll('.lawyer-card').forEach(card => card.classList.remove('selected'));

            // Select this one
            const card = document.querySelector(`[data-lawyer-id="${lawyerId}"]`);
            card.classList.add('selected');

            const lawyer = allLawyers.find(l => l.user_id === lawyerId);

            document.getElementById('selected-lawyer-id').value = lawyerId;
            document.getElementById('selected-lawyer-name').textContent = lawyer.name;
            document.getElementById('selected-lawyer-spec').textContent = lawyer.speciality;
            document.getElementById('selected-lawyer-cost').textContent = lawyer.cost_per_hearing.toLocaleString();

            // Auto-advance to step 3
            setTimeout(() => goToStep(3), 500);
        }

        // Step navigation
        function goToStep(step) {
            currentStep = step;

            //// Hide all steps
            document.querySelectorAll('.form-step').forEach(s => s.style.display = 'none');

            // Update step indicators
            for (let i = 1; i <= 3; i++) {
                const stepEl = document.getElementById(`step${i}`);
                stepEl.classList.remove('active', 'completed');
                if (i < step) stepEl.classList.add('completed');
                else if (i === step) stepEl.classList.add('active');
            }

            // Show current step
            if (step === 1) document.getElementById('domain-step').style.display = 'block';
            else if (step === 2) document.getElementById('lawyer-step').style.display = 'block';
            else if (step === 3) document.getElementById('details-step').style.display = 'block';
        }

        // Form submission
        document.getElementById('create-case-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const caseType = document.getElementById('case-type').value;
            const description = document.getElementById('description').value;
            const hearingDate = document.getElementById('hearing-date').value;
            const selectedLawyerId = document.getElementById('selected-lawyer-id').value;
            const messageArea = document.getElementById('message-area');
            const submitBtn = e.target.querySelector('button[type="submit"]');

            messageArea.innerHTML = '';

            // Validate hearing date is in the future
            if (new Date(hearingDate) <= new Date()) {
                messageArea.innerHTML = '<div class="alert alert-error">Hearing date must be in the future</div>';
                return;
            }

            // Disable submit button to prevent double-submission
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating Case...';

            try {
                const caseData = {
                    case_type: caseType,
                    description: description,
                    hearing_date: hearingDate,
                    lawyer_id: selectedLawyerId,
                    speciality: document.getElementById('selected-lawyer-spec').textContent
                };

                const response = await API.createCase(caseData);

                if (response.assignment_status === 'auto_assigned') {
                    showAlert(`Case created! Your selected lawyer was busy, so we assigned it to ${response.assigned_to_name}.`, 'success');
                } else {
                    const urgencyBadge = response.case.urgency_level === 'urgent' ? 'üî¥' :
                        response.case.urgency_level === 'high' ? 'üü°' : 'üü¢';
                    showAlert(`Case created successfully! ${urgencyBadge} ${response.case.urgency_level.toUpperCase()} priority (Hearing in ${response.case.days_until_hearing} days)`, 'success');
                }

                // Redirect to dashboard
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 1500);

            } catch (error) {
                // Check if all specialists are busy (503 error)
                if (error.statusCode === 503 && error.data) {
                    showAllBusyModal(error.data.message, error.data.contact);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Case';
                } else {
                    messageArea.innerHTML = `<div class="alert alert-error">${error.message}</div>`;
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Create Case';
                }
            }
        });

        function showAllBusyModal(message, contact) {
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-phone').textContent = contact.phone;
            document.getElementById('modal-email').textContent = contact.email;
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
            window.location.href = 'dashboard.html';
        }

        // Initialize
        loadLawyers();
    </script>
</body>

</html>