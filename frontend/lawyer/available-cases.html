<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Available Cases - Legal Case Management</title>
    <link rel="stylesheet" href="../styles.css">
</head>

<body>
    <div class="header">
        <div class="header-content">
            <h1>Legal Case Management - Lawyer Portal</h1>
            <nav class="nav-links">
                <a href="dashboard.html">Dashboard</a>
                <a href="available-cases.html">Available Cases</a>
                <a href="pending-requests.html">My Requests</a>
                <a href="cases.html">My Cases</a>
                <a href="profile.html">Profile</a>
                <button class="btn btn-secondary" onclick="handleLogout()">Logout</button>
            </nav>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h2>Available Cases Pool</h2>
                    <p class="text-muted">Cases sent to all lawyers - First-come, first-served (FIFO)</p>
                </div>
                <div>
                    <p><strong>Your Cases:</strong> <span id="case-count">0</span> / 2</p>
                </div>
            </div>

            <div id="available-cases">
                <p class="loading">Loading available cases...</p>
            </div>
        </div>
    </div>

    <script src="../app.js"></script>
    <script>
        if (!requireAuth('lawyer')) {
            // Redirected
        }

        async function loadAvailableCases() {
            try {
                const data = await API.getAvailableCases();
                const casesDiv = document.getElementById('available-cases');
                const caseCountSpan = document.getElementById('case-count');

                caseCountSpan.textContent = data.your_case_count;

                if (data.available_cases && data.available_cases.length > 0) {
                    // Sort: urgent first (already from priority queue)
                    casesDiv.innerHTML = data.available_cases.map(c => `
                        <div class="card ${c.urgency ? 'urgent' : ''}" style="border-left: 4px solid ${c.urgency ? 'var(--urgent-color)' : 'var(--border-color)'}">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <p><strong>Case ID:</strong> ${c.case_id}</p>
                                    <p><strong>Type:</strong> ${c.case_type}</p>
                                    <p><strong>Client ID:</strong> ${c.client_id}</p>
                                    <p><strong>Description:</strong> ${c.description}</p>
                                    <p class="text-muted" style="font-size: 12px;">Created: ${formatDate(c.created_at)}</p>
                                    ${c.urgency ? '<span class="urgent-badge">Urgent - Priority Queue</span>' : '<span class="text-muted">Normal Queue (FIFO)</span>'}
                                </div>
                                <div>
                                    ${data.your_case_count < data.max_cases ?
                            `<button class="btn btn-primary" onclick="claimCase('${c.case_id}')">Claim Case</button>` :
                            `<button class="btn btn-secondary" disabled>Max Cases Reached</button>`
                        }
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    casesDiv.innerHTML = `
                        <div class="empty-state">
                            <p>No available cases in the pool</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading available cases:', error);
                showAlert('Error loading cases: ' + error.message, 'error');
            }
        }

        async function claimCase(caseId) {
            if (!confirm('Claim this case? It will be added to your active cases.')) return;

            try {
                await API.claimCase(caseId);
                showAlert('Case claimed successfully!', 'success');
                loadAvailableCases(); // Reload
            } catch (error) {
                showAlert('Error claiming case: ' + error.message, 'error');
            }
        }

        loadAvailableCases();
    </script>
</body>

</html>